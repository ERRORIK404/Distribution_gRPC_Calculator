# Распределённый вычислитель арифметических выражений
## Введение
В этом проекте представлены сервера, где первый - расспределитель задач (оркестратор), а остальные представляют неограниченное количество серверов исполнителей, 
которые общаються с оркестратором с помощью gRPC запросов. Назовем их агентами.
Для начала, пользователю необходимо зарегистрироваться[Перейти к разделу "Эндпоинты и возможности сервера"](#Эндпоинты-и-возможности-сервера), затем пользователь получает cookie в котором содержиться JWT токен для дальнейшей авторизации(тем кто тестирует проект через утилиту curl внимательно смотрите примеры приведенные тут[Перейти к разделу "Эндпоинты и возможности сервера"](#Эндпоинты-и-возможности-сервера))
Пользователь хочет считать арифметические выражения. Он вводит строку 2 + 2 * 2 и хочет получить в ответ 6.
Но представим, что наши операции сложения и умножения (также деление и вычитания) выполняются "очень-очень" долго.
Поэтому вариант, при котором пользователь делает http-запрос и получает в качестве ответа результат, невозможна.
Более того: вычисление каждой такой операции в нашей "альтернативной реальности" занимает "гигантские" вычислительные мощности.
Соответственно каждое действие мы должны уметь выполнять отдельно и масштабировать эту систему можем добавлением вычислительных мощностей в нашу систему в виде новых "машин".
Поэтому пользователь может с какой-то периодичностью уточнять у сервера "не посчиталось ли выражение"? Если выражение наконец будет вычислено - то он получит результат.
## Установка и запуск
Для начала убедитесь, что у вас установлен Go версии 1.21 и выше с помощью команды
```
go version
```
Если она не работает установите Go.
Для скачивания репозитория выполните:
```
git clone https://github.com/ERRORIK404/Distr_Arith_Calculator/
```
При запуске автоматически скачивается библиотека godotenv для работы с файлом конфигурации, если возникает ошибка попробуйте установить вручную.
```
go get github.com/joho/godotenv
```

### Запуск серверов
Перед запуском, следует обратить внимание на файл конфигурации .env, в нем представленны 5 переменных окружения:
1) TIME_ADDITION_MS - время выполнения операции сложения в миллисекундах
2) TIME_SUBTRACTION_MS - время выполнения операции вычитания в миллисекундах
3) TIME_MULTIPLICATIONS_MS - время выполнения операции умножения в миллисекундах
4) TIME_DIVISIONS_MS - время выполнения операции деления в миллисекундах

При старте демон запускает несколько горутин, каждая из которых выступает в роли независимого вычислителя. Количество горутин регулируется переменной среды COMPUTING_POWER.
```
cd Distr_Arith_Calculator/
go run cmd/main.go
```
## Примечание 
Калькулятор поддерживает:
* Пробелы
* Операции +, -, *, и /
* Скобки любого уровня вложенности
* Дробные числа разделенные точкой

Благодаря системе статусов и организации доступа с использованием мьютексов, никакие 2 агента не могут выполнять одну и туже задачу.

## Схема общения серверов
![image](https://github.com/user-attachments/assets/2697f7d3-a113-4de3-90ba-19f23ed7e177)
## Дерево проекта
```
Distr_Arith_Calculator
├── cmd
│   └── main.go
├── environment_variables.env
├── go.mod
├── go.sum
├── internal
│   ├── agent_application
│   │   └── agent_application.go
│   └── orchestrator_application
│       └── orchestrator_application.go
├── pkg
│   ├── config
│   │   └── config.go
│   ├── converter_to_RPN
│   │   └── converter_to_RPN.go
│   ├── local_errors
│   │   └── local_errors.go
│   └── structs
│       └── structs.go
└── README.md
```
## Эндпоинты и возможности сервера
### Оркестратор
Сервер, который имеет следующие endpoint-ы:

#### Добавление вычисления арифметического выражения
```
curl --location 'localhost/api/v1/calculate' \
--header 'Content-Type: application/json' \
--data '{
  "expression": <строка с выражение>
}'
```
Коды ответа: 201 - выражение принято для вычисления, 422 - невалидные данные, 500 - что-то пошло не так

Тело ответа
```
{
    "id": <уникальный идентификатор выражения>
}
```
#### Получение списка выражений
```
curl --location 'localhost/api/v1/expressions'
Тело ответа

{
    "expressions": [
        {
            "id": <идентификатор выражения>,
            "status": <статус вычисления выражения>,
            "result": <результат выражения>
        },
        {
            "id": <идентификатор выражения>,
            "status": <статус вычисления выражения>,
            "result": <результат выражения>
        }
    ]
}
```
Коды ответа:

200 - успешно получен список выражений
500 - что-то пошло не так

#### Получение выражения по его идентификатору

```
curl --location 'localhost/api/v1/expressions/:id'
```
Коды ответа:

200 - успешно получено выражение
404 - нет такого выражения
500 - что-то пошло не так
Тело ответа
```
{
    "expression":
        {
            "id": <идентификатор выражения>,
            "status": <статус вычисления выражения>,
            "result": <результат выражения>
        }
}
```
#### Получение задачи для выполнения (Get запрос от агента)
Данный endpoint не задействован пользователем он нужен для общения оркестратора с агентами
```
curl --location 'localhost/internal/task'
```
Коды ответа:

200 - успешно получена задача
404 - нет задачи
500 - что-то пошло не так
Тело ответа
```
{
    "task":
        {
            "id": <идентификатор задачи>,
            "arg1": <имя первого аргумента>,
            "arg2": <имя второго аргумента>,
            "operation": <операция>,
            "operation_time": <время выполнения операции>
        }
}
```
#### Прием результата обработки данных (POST запрос от агента)
```
curl --location 'localhost/internal/task' \
--header 'Content-Type: application/json' \
--data '{
  "id": 1,
  "result": 2.5
}'
```
Коды ответа:

200 - успешно записан результат
500 - что-то пошло не так

### Агент 
Общается с оркестратором по http запросам
Агент все время приходит к оркестратору с запросом "дай задачку поработать" (в ручку GET internal/task для получения задач). Оркестратор отдаёт задачу.
Агент производит вычисление и в ручку оркестратора (POST internal/task для приема результатов обработки данных) отдаёт результат

## Конкретные примеры с использованием Postman
### Получение оркестратором задачи
![image](https://github.com/user-attachments/assets/8e1caef6-7588-42d4-9f79-40952cb984c6)
## Получение задачи по ее индентификатору
![image](https://github.com/user-attachments/assets/54365bda-7837-45ce-adb4-0fd00060dd1d)
## Получение списка всех задач
![image](https://github.com/user-attachments/assets/0cd79523-d5e2-4729-953a-bc9f760ba7b4)

