# Распределённый вычислитель арифметических выражений
## Основная информация
В этом проекте представлены сервера, где первый - расспределитель задач (оркестратор), а остальные представляют неограниченное количество серверов исполнителей, 
которые общаються с оркестратором с помощью gRPC запросов. Назовем их агентами.
Вся история выражений храниться в SQLite, бд представлена файлом который лежит в корне проекта.
Если файла нет(удалили, чтобы сбросить данные), то при запуске он создастся сам.
Весь сервис работает в контексте одного пользователя, то есть история выражений видна только восле авторизации, и видны только выражения отправленные именно этим пользователем.
База данных способна пережить перезагрузку сервера, вся история сохраниться, **однако не посчитанные до конца выражения не смогут быть вычеслены**.
Для начала, пользователю необходимо [зарегистрироваться](#Эндпоинты-и-возможности-сервера), затем пользователь получает cookie в котором содержиться JWT токен для дальнейшей авторизации.

***Тем кто тестирует проект через утилиту curl внимательно смотрите примеры приведенные [тут](#Эндпоинты-и-возможности-сервера)***

Пользователь хочет считать арифметические выражения. Он вводит строку 2 + 2 * 2 и хочет получить в ответ 6.
Но представим, что наши операции сложения и умножения (также деление и вычитания) выполняются "очень-очень" долго.
Поэтому вариант, при котором пользователь делает http-запрос и получает в качестве ответа результат, невозможна.
Более того: вычисление каждой такой операции в нашей "альтернативной реальности" занимает "гигантские" вычислительные мощности.
Соответственно каждое действие мы должны уметь выполнять отдельно и масштабировать эту систему можем добавлением вычислительных мощностей в нашу систему в виде новых "машин".
Поэтому пользователь может с какой-то периодичностью уточнять у сервера "не посчиталось ли выражение"? Если выражение наконец будет вычислено - то он получит результат.
## Установка и запуск
Для начала убедитесь, что у вас установлен Go версии 1.21 и выше с помощью команды
```
go version
```
Если она не работает установите Go.
Для скачивания репозитория выполните:
```
git clone https://github.com/ERRORIK404/Distribution_gRPC_Calculator/
```
Перед запуском возможно придется подтянуть зависимости:
```
go mod tidy
```

### Запуск серверов
Перед запуском, следует обратить внимание на файл конфигурации .env, в нем представленны 5 переменных окружения:
1) TIME_ADDITION_MS - время выполнения операции сложения в миллисекундах
2) TIME_SUBTRACTION_MS - время выполнения операции вычитания в миллисекундах
3) TIME_MULTIPLICATIONS_MS - время выполнения операции умножения в миллисекундах
4) TIME_DIVISIONS_MS - время выполнения операции деления в миллисекундах
5) COMPUTING_POWER - количество дочерних серверов(агентов) 
6) JWT_SECRET - секретный ключ для создания и проверки JWT токенов

При старте демон запускает несколько горутин, каждая из которых выступает в роли независимого вычислителя. Количество горутин регулируется переменной среды COMPUTING_POWER.
```
cd Distribution_gRPC_Calculator/
go run cmd/main.go
```
## Примечание 
Калькулятор поддерживает:
* Пробелы
* Операции +, -, *, и /
* Скобки любого уровня вложенности
* Дробные числа разделенные точкой

Благодаря системе статусов и организации доступа с использованием мьютексов, никакие 2 агента не могут выполнять одну и туже задачу.

## Схема общения серверов
![image](https://github.com/user-attachments/assets/2697f7d3-a113-4de3-90ba-19f23ed7e177)
## Дерево проекта
```
Distribution_gRPC_Calculator
├── calculator.db
├── cmd
│   └── main.go
├── database
│   ├── db.go
│   ├── history.go
│   ├── schema.sql
│   └── users.go
├── go.mod
├── go.sum
├── internal
│   ├── agent_application
│   │   └── agent_application.go
│   └── orchestrator_application
│       └── orchestrator_application.go
├── pkg
│   ├── config
│   │   └── config.go
│   ├── converter_to_RPN
│   │   └── converter_to_RPN.go
│   ├── db_models
│   │   └── db_models.go
│   ├── hashing
│   │   └── hashing.go
│   ├── local_errors
│   │   └── local_errors.go
│   ├── proto
│   │   ├── OrchestratorServer_grpc.pb.go
│   │   ├── OrchestratorServer.pb.go
│   │   └── OrchestratorServer.proto
│   ├── structs
│   │   └── structs.go
│   ├── tokenezation
│   │   └── tokenezation.go
│   └── validator
│       └── valid.go
└── README.md
```
## Эндпоинты и возможности сервера
### Оркестратор
Возможно стоит использовать приложение Postman он автоматически сохраняет куки, что делает тестирование гораздо легче, однако приведу примеры с использование curl 

Сервер, который имеет следующие endpoint-ы:
### **Регистрация пользователя**
```
curl -v -X POST http://localhost:8080/api/v1/auth/register \
     -H "Content-Type: application/json" \
     -d '{"login":"user", "password":"qwerty"}'
```
Коды ответа 
- 201 - пользователь создан
- 422 - невалидные данные (также есть защита от sql и XSS атак
- 500 - ошибка на стороне сервера, возможно ошабка выглядит так (UNIQUE constraint failed: ...), это значит что такой пользователь уже существует
#### **Авторизация пользователя**
```
curl -v -X POST http://localhost:8080/api/v1/auth/login \
     -H "Content-Type: application/json" \
     -d '{"login":"user", "password":"qwerty"}' \
     -c cookies.txt  # Сохраняем куки в файл
```
Внимательно следите за тем, чтобы сохранились куки 
Коды ответа
- 200 - авторизация прошла успешна, сервер вернул куки с токеном
- 400 - неправильное тело запроса
- 401 - Unauthorized, неверные логин или пароль
- 500 - внутренняя ошибка сервера
#### Добавление вычисления арифметического выражения
```
curl --location 'localhost/api/v1/calculate' \
    --header 'Content-Type: application/json' \
    -b cookies.txt \
    --data '{
      "expression": "2+2" \
    }'

```
Коды ответа: 
- 201 - выражение принято для вычисления
- 422 - невалидные данные
- 500 - что-то пошло не так

Тело ответа
Стоит сохранить айди конкретного выражения, ведь сервер имеет эндпоинт, который позволяет найи нужное выражение
```
{
    "id": <уникальный идентификатор выражения>
}
```
#### Получение списка выражений
```
curl --location 'http://localhost:8080/api/v1/expressions' \
     -b cookies.txt 
```
Тело ответа
```
{
    "expressions": [
        {
            "id": <идентификатор выражения>,
            "status": <статус вычисления выражения>,
            "result": <результат выражения>
        },
        {
            "id": <идентификатор выражения>,
            "status": <статус вычисления выражения>,
            "result": <результат выражения>
        },
        // Полная история выражений...
    ]
}
```
Коды ответа:

200 - успешно получен список выражений
500 - что-то пошло не так

#### Получение выражения по его идентификатору

```
curl --location 'http://localhost:8080/api/v1/expressions/:id' \
     -b cookies.txt \
```
Коды ответа:

200 - успешно получено выражение
404 - нет такого выражения
500 - что-то пошло не так
Тело ответа
```
{
    "expression":
        {
            "id": <идентификатор выражения>,
            "status": <статус вычисления выражения>,
            "result": <результат выражения>
        }
}
```

### Агент 
Общается с оркестратором по gRPC запросам
Агент все время приходит к оркестратору с запросом "дай задачку поработать" (gRPC запрос GetTask для получения задач). Оркестратор отдаёт задачу.
Агент производит вычисление и в ручку оркестратора (SendResult для приема результатов обработки данных) отдаёт результат

## Конкретные примеры с использованием Postman
### Регистрация пользователя
![image](https://github.com/user-attachments/assets/3e6c7616-8c56-4af2-a3e8-b61a997e86e5)
### Авторизация пользователя
![image](https://github.com/user-attachments/assets/c364902a-4f4d-4329-ad18-9b53903204df)
### Получение задачи от пользователя
![image](https://github.com/user-attachments/assets/9fccc443-81da-4118-83b7-3e8c13bea409)
### Получение задачи по ее индентификатору
![image](https://github.com/user-attachments/assets/b729aef8-185c-4a31-89c9-d1fa992a4c08)
### Получение списка всех задач
![image](https://github.com/user-attachments/assets/fa68a572-bc28-4040-989c-6fc186cc765f)
### Пример куки
![image](https://github.com/user-attachments/assets/3502b786-356d-4a62-b9b8-c4bd4e4b4580)


